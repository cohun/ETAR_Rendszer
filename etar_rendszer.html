<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETAR Rendszer</title>
    <link rel="icon" type="image/png" href="ETAR_H-IITB_512.png">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS (xlsx) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- PizZip, Docxtemplater -->
    <script src="https://cdn.jsdelivr.net/npm/pizzip@3.1.4/dist/pizzip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docxtemplater@3.34.2/build/docxtemplater.js"></script>
    <!-- FileSaver.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- JSZip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .screen { display: none; }
        .screen.active { display: block; }
        .input-field {
            background-color: white; color: black !important; font-weight: bold;
            width: 100%; padding: 0.5rem; border-radius: 0.375rem;
            border: 1px solid #93c5fd; transition: all 0.2s;
        }
        .input-field:focus {
            outline: 2px solid transparent; outline-offset: 2px;
            border-color: #3b82f6; box-shadow: 0 0 0 2px #3b82f6;
        }
        .input-field::placeholder { color: #a0aec0; font-weight: normal; }
        select.input-field:invalid { color: #a0aec0 !important; font-weight: normal; }
        .btn { @apply px-6 py-2 rounded-md font-semibold text-white transition-transform transform hover:scale-105 shadow-lg; }
        .btn:disabled { @apply bg-slate-500 cursor-not-allowed scale-100; }
        .btn-primary { @apply bg-blue-600 hover:bg-blue-700; }
        .btn-secondary { @apply bg-slate-600 hover:bg-slate-700; }
        .btn-success { @apply bg-green-600 hover:bg-green-700; }
        .btn-danger { @apply bg-red-600 hover:bg-red-700; }
        .card { @apply bg-blue-950/50 p-6 sm:p-8 rounded-xl shadow-2xl border border-blue-800; }
        .loader {
            border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db;
            width: 40px; height: 40px; animation: spin 2s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Modal Stílusok */
        .modal-overlay {
            @apply fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50;
        }
        .modal-content {
            @apply bg-slate-800 text-white p-8 rounded-lg shadow-xl max-w-lg w-full;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-blue-900 text-gray-200 min-h-screen flex items-center justify-center p-4">
    
    <img src="ETAR_H.png" alt="ETAR-H Logó" class="fixed top-4 left-4 w-24 h-24 rounded-full border-2 border-blue-400 shadow-xl z-50 transition-transform hover:scale-110">

    <div class="container mx-auto max-w-5xl">

        <!-- Képernyők -->
        <div id="loginScreen" class="screen active text-center">
             <div class="card max-w-md mx-auto">
                <img src="logo.jpg" alt="ETAR Logó" class="mx-auto mb-8 w-64 h-auto rounded-lg shadow-md" onerror="this.onerror=null; this.src='https://placehold.co/256x100/172554/ffffff?text=ETAR+Logo';">
                <h1 class="text-3xl sm:text-4xl font-bold mb-2">ETAR Rendszer</h1>
                <p class="mb-8 text-blue-300">Kérjük, jelentkezzen be Google fiókjával a használathoz.</p>
                <div id="signInButtonWrapper">
                    <button id="signInButton" class="btn btn-primary text-lg w-full" disabled>Bejelentkezés Google Fiókkal</button>
                </div>
                <div id="loadingStatus" class="mt-6 text-center">
                    <div class="loader mx-auto"></div>
                    <p class="mt-2">Google szolgáltatások betöltése...</p>
                </div>
            </div>
        </div>
        <div id="ejkPartnerSelectScreen" class="screen">
            <div class="card max-w-2xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold">Partner Adatbázis Kiválasztása (EJK)</h1>
                    <button id="signOutButtonEjk" class="btn btn-secondary text-sm">Kijelentkezés</button>
                </div>
                <div id="currentPartnerInfo" class="mb-4"></div>
                <p id="ejkUserInfo" class="mb-6 text-blue-300"></p>
                <div id="partnerList" class="space-y-2"></div>
                <div id="ejkStatus" class="mt-6 text-center"></div>
            </div>
        </div>
        <div id="ejkMainScreen" class="screen text-center">
             <div class="card">
                <div class="flex justify-between items-center mb-4">
                    <button id="backToPartnerSelectBtn" class="btn btn-secondary text-sm">Vissza a partnerekhez</button>
                    <h2 id="ejkSelectedPartner" class="text-xl font-bold"></h2>
                    <div class="w-32"></div> <!-- Placeholder for spacing -->
                </div>
                <h1 class="text-3xl sm:text-4xl font-bold mb-8">ETAR Jegyzőkönyv Készítő (EJK)</h1>
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <button id="ejkNewEntryBtn" class="btn btn-primary text-lg">1. Új adat bevitel</button>
                    <button id="ejkReadExcelBtn" class="btn btn-secondary text-lg">2. Jegyzőkönyv Készítés</button>
                </div>
            </div>
        </div>
        <div id="enyMainScreen" class="screen"></div>
        <div id="deviceDetailsScreen" class="screen"></div>
        <div id="dataEntryScreen" class="screen"></div>
        <div id="ejkGenerateDocsScreen" class="screen"></div>
    </div>
    
    <!-- Megerősítő Modal -->
    <div id="confirmationModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 id="modalTitle" class="text-2xl font-bold mb-4">Mentés Megerősítése</h2>
            <p id="modalMessage" class="mb-6"></p>
            <div id="modalStats" class="mb-6 bg-slate-700 p-4 rounded text-lg space-y-2"></div>
            <div class="flex justify-end gap-4">
                <button id="modalCancelBtn" class="btn btn-secondary">Mégse</button>
                <button id="modalConfirmBtn" class="btn btn-success">Megerősítés</button>
            </div>
        </div>
    </div>
    
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

        <script>
    // ===================================================================================
    // FONTOS BEÁLLÍTÁSOK
    // ===================================================================================
    const API_KEY = 'AIzaSyBfcVv4o1nhi26mncDin_P1dSucArZt1MY'; // Ezt később obfuszkáljuk
    const CLIENT_ID = '275625800423-lm3nn50kiq6ld3n56vtfocb627fvbek9.apps.googleusercontent.com'; // Ezt később obfuszkáljuk
    const ROUTING_TABLE_FOLDER_ID = '1pzigXXQ7-Ed-PGlhFeDm7fzG6W3Lzptp'; // Az 'Utvonal' mappa ID-ja
    const MAIN_ROOT_FOLDER_ID = '1spypeyZmJ19qTHgVuFkaucu7zvI9qmuv'; // A központi EJK mappa ID-ja
    // ===================================================================================

    const SCOPES = 'https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email';

    let userRootFolderId = null; // Dinamikusan fogjuk beállítani
    let gapiInited = false;
    let gisInited = false;
    let tokenClient;
    let userProfile = null;
    
    let currentPartner = {};
    let partnerDatabase = []; 
    let companyData = {};
    let newDeviceData = [];
    let lastDeviceData = {};
    
    const expertIds = {
        "Nagy Imre": "P94B 146259",
        "Gerőly Iván": "PTG 032946",
        "Szadlon Norbert": "CXBC 539792",
        "Bagyinszki Lóránt": "CXBC 1671430"
    };

    let screens = {};
    
    // --- ÁLTALÁNOS FÜGGVÉNYEK ---
    function showScreen(screenId) {
        Object.values(screens).forEach(screen => screen.classList.remove('active'));
        screens[screenId].classList.add('active');
    }

    function setStatus(elementId, message, isError = false) {
        const el = document.getElementById(elementId);
        if (el) {
            el.innerHTML = message;
            el.className = `mt-6 text-center ${isError ? 'text-red-400' : 'text-blue-300'}`;
        }
    }

    const findValue = (obj, key) => {
        if (!obj || !key) return '';
        const keyToFind = key.toLowerCase().trim();
        const foundKey = Object.keys(obj).find(k => k.toLowerCase().trim() === keyToFind);
        const value = foundKey ? obj[foundKey] : '';
        return value === null || value === undefined ? '' : String(value);
    };

    function readFileAsArrayBuffer(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = e => resolve(e.target.result);
            reader.onerror = e => reject(e);
            reader.readAsArrayBuffer(file);
        });
    }

    // --- GOOGLE API INICIALIZÁLÁS ---
    function gapiLoaded() { gapi.load('client', initializeGapiClient); }
    async function initializeGapiClient() {
        // Az apiKey-t eltávolítjuk, mert a felhasználói adatokhoz (pl. fájllistázás)
        // a bejelentkezés után kapott access_token-t kell használni, nem az API kulcsot.
        await gapi.client.init({
            discoveryDocs: [
                'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
                'https://people.googleapis.com/$discovery/rest?version=v1'            ],
        });
        gapiInited = true;
        checkInitStatus();
    }
    function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID, scope: SCOPES, callback: '', 
        });
        gisInited = true;
        checkInitStatus();
    }
    function checkInitStatus() {
        if (gapiInited && gisInited) {
            setStatus('loadingStatus', 'A rendszer készen áll a bejelentkezésre.');
            document.getElementById('signInButton').disabled = false;
        }
    }
    
    // --- INICIALIZÁLÁS ÉS ESEMÉNYKEZELŐK ---
    document.addEventListener('DOMContentLoaded', initializeApp);

    function initializeApp() {
        screens = {
            login: document.getElementById('loginScreen'),
            ejkSelect: document.getElementById('ejkPartnerSelectScreen'),
            ejkMain: document.getElementById('ejkMainScreen'),
            enyMain: document.getElementById('enyMainScreen'),
            details: document.getElementById('deviceDetailsScreen'),
            dataEntry: document.getElementById('dataEntryScreen'),
            ejkGenerateDocs: document.getElementById('ejkGenerateDocsScreen'),
        };

        // KÖZPONTI ESEMÉNYKEZELŐ (EVENT DELEGATION)
        document.body.addEventListener('click', (event) => {
            const target = event.target.closest('button');
            if (!target) return;
            
            if (target.id === 'signInButton') handleSignIn();
            if (target.id === 'signOutButtonEjk' || target.id === 'signOutButtonEny') handleSignOut();
            if (target.id === 'backToPartnerSelectBtn') showScreen('ejkSelect');
            if (target.id === 'backToEjkMainBtn') showScreen('ejkMain');
            if (target.id === 'ejkNewEntryBtn') showEjkDataEntry();
            if (target.id === 'ejkReadExcelBtn') showEjkDocGeneration();
            if (target.id === 'addAnotherDeviceBtnEjk') handleAddAnotherDeviceEjk();
            if (target.id === 'saveToDriveBtnEjk') showSaveConfirmation();
            if (target.id === 'processFilesBtnEjk') handleProcessFilesEjk();

            if (target.dataset.sortKey) {
                handleSortDeviceList(target.dataset.sortKey);
            }
            
            if (target.dataset.partnerId) {
                 selectPartner({
                    name: target.dataset.partnerName,
                    id: target.dataset.partnerId,
                 });
            }
        });

        // Eseménykezelő a "Mindent kijelöl" checkboxhoz
        document.body.addEventListener('change', event => {
            if (event.target.id === 'selectAllCheckboxEjk') {
                const isChecked = event.target.checked;
                document.querySelectorAll('#deviceListEjk input[type="checkbox"]').forEach(cb => {
                    cb.checked = isChecked;
                });
            }
        });
    }

    // --- BEJELENTKEZÉSI LOGIKA ---
    function handleSignIn() {
        tokenClient.callback = async (resp) => {
            if (resp.error !== undefined) {
                setStatus('loadingStatus', `Hiba a bejelentkezés során: ${resp.error}`, true);
                return;
            }
            setStatus('loadingStatus', '<div class="loader mx-auto"></div><p class="mt-2">Bejelentkezés sikeres. Jogosultságok ellenőrzése...</p>');
            await fetchUserProfile();
            if (userProfile) await checkUserRole();
        };
        if (gapi.client.getToken() === null) {
            tokenClient.requestAccessToken({ prompt: 'consent' });
        } else {
            tokenClient.requestAccessToken({ prompt: '' });
        }
    }

    async function fetchUserProfile() {
        try {
            const response = await gapi.client.people.people.get({
                resourceName: 'people/me', personFields: 'names,emailAddresses',
            });
            const profile = response.result;
            userProfile = {
                name: profile.names?.[0]?.displayName || 'Ismeretlen felhasználó',
                email: profile.emailAddresses?.[0]?.value || 'Nincs e-mail cím'
            };
        } catch (err) {
            const errorDetails = err.result?.error?.message || err.toString();
            setStatus('loadingStatus', `Hiba a felhasználói profil lekérése közben: ${errorDetails}`, true);
            userProfile = null;
        }
    }
    
    // --- SZEREPKÖR-KEZELÉS ---
    async function checkUserRole() {
        if (!userProfile || !userProfile.email) {
            showUnauthorizedUser("Nem sikerült lekérni az e-mail címet a jogosultság ellenőrzéséhez.");
            return;
        }

        setStatus('loadingStatus', '<div class="loader mx-auto"></div><p class="mt-2">Jogosultsági útvonal keresése...</p>');
        const route = await getUserRoute(userProfile.email);

        if (!route) {
            showUnauthorizedUser(`Nincs jogosultság definiálva a(z) ${userProfile.email} címhez.`);
            return;
        }

        userRootFolderId = route.folder_id;

        if (userRootFolderId === MAIN_ROOT_FOLDER_ID) {
            // EJK Felhasználó: Hozzáférése van a fő mappához
            showEjkScreen();
        } else {
            // ENY Felhasználó: Hozzáférése van egy specifikus partnermappához
            showEnyScreen({ id: userRootFolderId, name: route.folder_name || 'Partner Mappa' });
        }
    }

    async function getUserRoute(userEmail) {
        try {
            const response = await gapi.client.drive.files.list({
                q: `'${ROUTING_TABLE_FOLDER_ID}' in parents and name='utvonalak.xlsx' and trashed=false`,
                fields: 'files(id)'
            });
            if (!response.result.files || response.result.files.length === 0) {
                throw new Error("Az 'utvonalak.xlsx' fájl nem található.");
            }
            const fileId = response.result.files[0].id;
            const fileResponse = await gapi.client.drive.files.get({ fileId: fileId, alt: 'media' });
            const workbook = XLSX.read(fileResponse.body, { type: 'binary' });
            const routingData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            
            return routingData.find(row => findValue(row, 'email').toLowerCase() === userEmail.toLowerCase());
        } catch (err) {
            const errorDetails = err.result?.error?.message || err.message || err.toString();
            setStatus('loadingStatus', `Hiba a jogosultsági tábla olvasása közben: ${errorDetails}`, true);
            return null;
        }
    }

    async function showEjkScreen() {
        showScreen('ejkSelect'); // A partner-választó képernyőre navigálunk
        document.getElementById('ejkUserInfo').textContent = `Bejelentkezve: ${userProfile.name} (${userProfile.email})`;
        setStatus('ejkStatus', '<div class="loader mx-auto"></div><p class="mt-2">Partnermappák betöltése...</p>');
        try {
            const response = await gapi.client.drive.files.list({
                q: `'${userRootFolderId}' in parents and mimeType = 'application/vnd.google-apps.folder' and trashed = false`,
                fields: 'files(id, name)', orderBy: 'name'
            });
            const partners = response.result.files;
            const partnerListDiv = document.getElementById('partnerList');
            partnerListDiv.innerHTML = '';
            if (partners && partners.length > 0) {
                partners.forEach(partner => {
                    const button = document.createElement('button');
                    button.className = 'w-full text-left p-3 rounded-md transition-all font-semibold bg-blue-800 hover:bg-blue-700';
                    button.textContent = partner.name;
                    button.dataset.partnerId = partner.id;
                    button.dataset.partnerName = partner.name;
                    partnerListDiv.appendChild(button);
                });
                setStatus('ejkStatus', 'Válassz egy partnert a listából a folytatáshoz.');
            } else {
                 setStatus('ejkStatus', 'Nem találhatók partnermappák a központi tárolóban.', true);
            }
        } catch(err) {
            const errorMessage = err.result?.error?.message || err.toString();
            setStatus('ejkStatus', `Hiba a partnermappák listázása közben: ${errorMessage}`, true);
        }
    }
    
    async function selectPartner(partner) {
        currentPartner = { name: partner.name, folderId: partner.id };
        showScreen('ejkMain');
        document.getElementById('ejkSelectedPartner').textContent = partner.name;
        setStatus('ejkStatus', `<div class="loader mx-auto"></div><p class="mt-2">'${partner.name}' adatainak betöltése...</p>`);
        const dbLoaded = await loadDatabase(partner.id, 'ejkStatus');
        const companyDataLoaded = await loadCompanyData(partner.id, 'ejkStatus');
        if (dbLoaded && companyDataLoaded) {
            setStatus('ejkStatus', `Adatok sikeresen betöltve. Adatbázis: ${partnerDatabase.length} eszköz.`, false);
        }
    }

    async function showEnyScreen(partnerFolder) { 
        // TODO: Az ENY felhasználói felület implementálása.
        // Egyelőre egy üzenetet jelenítünk meg.
        showScreen('enyMain');
        document.getElementById('enyMainScreen').innerHTML = `<div class="card text-center"><h1 class="text-2xl font-bold">Üdv, ENY Felhasználó!</h1><p class="mt-4">A te mappád: ${partnerFolder.name} (${partnerFolder.id})</p><p class="mt-6">Az ENY felület fejlesztés alatt áll.</p><button id="signOutButtonEny" class="btn btn-secondary mt-8">Kijelentkezés</button></div>`;
    }

    // --- ADATBÁZIS KEZELÉS ---
    async function loadDatabase(folderId, statusElementId){
        setStatus(statusElementId, '<div class="loader mx-auto"></div><p class="mt-2">Adatbázis (`adatbazis.xlsx`) keresése...</p>');
        try {
            const response = await gapi.client.drive.files.list({
                q: `'${folderId}' in parents and name='adatbazis.xlsx' and trashed=false`, fields: 'files(id, name)'
            });
            if (response.result.files.length > 0) {
                 const fileId = response.result.files[0].id;
                 currentPartner.databaseFileId = fileId; 
                 setStatus(statusElementId, `<div class="loader mx-auto"></div><p class="mt-2">Adatbázis letöltése...</p>`);
                 const fileResponse = await gapi.client.drive.files.get({ fileId: fileId, alt: 'media' });
                 const workbook = XLSX.read(fileResponse.body, { type: 'binary' });
                 partnerDatabase = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {raw: false, dateNF:'yyyy-mm-dd'});
                 setStatus(statusElementId, `Adatbázis sikeresen betöltve, ${partnerDatabase.length} eszközzel.`, false);
                 return true;
            } else {
                 setStatus(statusElementId, 'Nem található `adatbazis.xlsx` fájl a partnermappában.', true);
                 partnerDatabase = []; return false;
            }
        } catch (err) {
            setStatus(statusElementId, 'Hiba történt az adatbázis beolvasása közben.', true);
            partnerDatabase = []; return false;
        }
    }

    async function loadCompanyData(folderId, statusElementId) {
        setStatus(statusElementId, '<div class="loader mx-auto"></div><p class="mt-2">Cégadatok (`ceg.xlsx`) keresése...</p>');
        try {
            const response = await gapi.client.drive.files.list({
                q: `'${folderId}' in parents and name='ceg.xlsx' and trashed=false`, fields: 'files(id, name)'
            });
            if (response.result.files.length > 0) {
                const fileId = response.result.files[0].id;
                currentPartner.companyDataFileId = fileId;
                const fileResponse = await gapi.client.drive.files.get({ fileId: fileId, alt: 'media' });
                const workbook = XLSX.read(fileResponse.body, { type: 'binary' });
                const companyDataArray = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                
                if (companyDataArray.length > 0) {
                    companyData = companyDataArray[0];
                    // ETAR kód generálása, ha szükséges
                    if (!findValue(companyData, 'ETAR kód')) {
                        const sourceString = `${findValue(companyData, 'Cégnév')}-${findValue(companyData, 'Cím')}`;
                        const encoder = new TextEncoder();
                        const dataBuffer = encoder.encode(sourceString);
                        const hashBuffer = await crypto.subtle.digest('SHA-256', dataBuffer);
                        const hashArray = Array.from(new Uint8Array(hashBuffer));
                        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                        companyData['ETAR kód'] = hashHex.substring(0, 6).toUpperCase();
                        
                        // Visszaírás a Drive-ra
                        await updateCompanyDataOnDrive();
                    }
                    return true;
                }
            }
            setStatus(statusElementId, 'Nem található `ceg.xlsx` fájl vagy üres. Kérlek, ellenőrizd a partner mappáját!', true);
            companyData = {};
            return false;
        } catch (err) {
            setStatus(statusElementId, 'Hiba történt a cégadatok beolvasása közben.', true);
            companyData = {};
            return false;
        }
    }

    async function updateCompanyDataOnDrive() {
        const workbook = XLSX.utils.book_new();
        const worksheet = XLSX.utils.json_to_sheet([companyData]); // A [companyData] fontos, mert a json_to_sheet tömböt vár
        XLSX.utils.book_append_sheet(workbook, worksheet, 'Cégadatok');
        const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
        const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        
        await uploadFile(currentPartner.companyDataFileId, blob);
    }

    function showUnauthorizedUser() { /* ... */ }
    function handleSignOut() {
        const token = gapi.client.getToken();
        if (token) {
            google.accounts.oauth2.revoke(token.access_token, () => {
                gapi.client.setToken('');
                userProfile = null; userRootFolderId = null; partnerDatabase = []; currentPartner = {};
                companyData = {}; showScreen('login');
                setStatus('loadingStatus', '');
            });
        }
    }
    
    // --- EJK FUNKCIÓK ---
    function showEjkDataEntry() {
        newDeviceData = [];
        const screen = screens.dataEntry;
        screen.innerHTML = getEjkDataEntryHtml();
        showScreen('dataEntry');
    }

    function showEjkDocGeneration() {
        const screen = screens.ejkGenerateDocs;
        screen.innerHTML = getEjkDocGenerationHtml();
        showScreen('ejkGenerateDocs');
    }
    
    function handleAddAnotherDeviceEjk() {
        const form = document.getElementById('dataEntryFormEjk');
        const formData = new FormData(form);
        const currentData = {};
        formData.forEach((value, key) => currentData[key] = value.trim());
        
        if (!currentData.eszkoz_megnevezes || !currentData.eszkoz_gyariszam) {
             alert('A "Megnevezés" és a "Gyári szám" mezők kitöltése kötelező!');
             return;
        }

        lastDeviceData = { ...currentData };
        
        const newRecord = {
            'Cégnév': findValue(companyData, 'Cégnév') || currentPartner.name,
            'Cím': findValue(companyData, 'Cím') || '',
            'Megnevezés': currentData.eszkoz_megnevezes,
            'Üzemeltetői azonosító': currentData.eszkoz_uzemeltetoi_azonosito,
            'Típus': currentData.eszkoz_tipus,
            'Gyártó': currentData.eszkoz_gyarto,
            'Gyári szám': currentData.eszkoz_gyariszam,
            'Gyártás éve': currentData.gyartas_eve,
            'Teherbírás (WLL)': currentData.eszkoz_teherbiras,
            'Hasznos hossz': currentData.eszkoz_hossz,
            'Vizsgálat helye': currentData.vizsgalat_helye,
            'Vizsgálat időpontja': currentData.vizsgalat_idopontja,
            'Vizsgálat jellege': currentData.vizsgalat_jellege,
            'Következő időszakos vizsgálat': currentData.kovetkezo_idoszakos_vizsgalat,
            'Következő terhelési próba': currentData.kovetkezo_terhelesi_proba,
            'Megállapítások': currentData.megallapitasok,
            'Feltárt hiba': currentData.hiba,
            'Felhasznált anyagok': currentData.intezkedes,
        };
        newDeviceData.push(newRecord);
        
        const notificationEl = document.getElementById('notificationEjk');
        notificationEl.textContent = `'${currentData.eszkoz_megnevezes}' hozzáadva. Összesen: ${newDeviceData.length} új tétel.`;
        setTimeout(() => { notificationEl.textContent = ''; }, 3000);
        
        form.reset();
        form.querySelectorAll('input, textarea').forEach(input => {
            input.placeholder = input.name === 'eszkoz_gyariszam' ? '' : lastDeviceData[input.name] || '';
        });
    }

    // --- BIZTONSÁGI MENTÉS MEGERŐSÍTÉSSEL ---
    function showSaveConfirmation() {
        const form = document.getElementById('dataEntryFormEjk');
        const formData = new FormData(form);
        const currentData = {};
        formData.forEach((value, key) => currentData[key] = value.trim());
        
        if (currentData.eszkoz_megnevezes && currentData.eszkoz_gyariszam) {
             const newRecord = {
                'Cégnév': findValue(companyData, 'Cégnév') || currentPartner.name,
                'Cím': findValue(companyData, 'Cím') || '',
                'Megnevezés': currentData.eszkoz_megnevezes,
                'Üzemeltetői azonosító': currentData.eszkoz_uzemeltetoi_azonosito,
                'Típus': currentData.eszkoz_tipus,
                'Gyártó': currentData.eszkoz_gyarto,
                'Gyári szám': currentData.eszkoz_gyariszam,
                'Gyártás éve': currentData.gyartas_eve,
                'Teherbírás (WLL)': currentData.eszkoz_teherbiras,
                'Hasznos hossz': currentData.eszkoz_hossz,
                'Vizsgálat helye': currentData.vizsgalat_helye,
                'Vizsgálat időpontja': currentData.vizsgalat_idopontja,
                'Vizsgálat jellege': currentData.vizsgalat_jellege,
                'Következő időszakos vizsgálat': currentData.kovetkezo_idoszakos_vizsgalat,
                'Következő terhelési próba': currentData.kovetkezo_terhelesi_proba,
                'Megállapítások': currentData.megallapitasok,
                'Feltárt hiba': currentData.hiba,
                'Felhasznált anyagok': currentData.intezkedes,
            };
             newDeviceData.push(newRecord);
             form.reset();
        }

        if (newDeviceData.length === 0) {
            alert('Nincs menthető új adat.');
            return;
        }

        const modal = document.getElementById('confirmationModal');
        const statsDiv = document.getElementById('modalStats');
        statsDiv.innerHTML = `
            <p>Eredeti sorok száma: <span class="font-bold text-blue-300">${partnerDatabase.length}</span></p>
            <p>Új sorok száma: <span class="font-bold text-yellow-300">${newDeviceData.length}</span></p>
            <hr class="my-2 border-slate-600">
            <p>Új teljes sorok száma: <span class="font-bold text-green-300">${partnerDatabase.length + newDeviceData.length}</span></p>
        `;
        
        modal.classList.remove('hidden');

        document.getElementById('modalCancelBtn').onclick = () => modal.classList.add('hidden');
        document.getElementById('modalConfirmBtn').onclick = () => {
            modal.classList.add('hidden');
            executeUpdateOnDrive();
        };
    }

    async function executeUpdateOnDrive() {
        const notificationEl = document.getElementById('notificationEjk');
        notificationEl.innerHTML = '<div class="loader mx-auto"></div><p>Adatbázis frissítése a Google Drive-on...</p>';
        
        const updatedDataForSheet = [...partnerDatabase, ...newDeviceData];

        if (!currentPartner.databaseFileId) {
            notificationEl.textContent = 'Hiba: Az adatbázis fájl azonosítója nem található!';
            notificationEl.className = 'text-center my-4 text-red-400 font-semibold h-auto';
            return;
        }

        try {
            // 1. Excel fájl létrehozása memóriában
            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.json_to_sheet(updatedDataForSheet);
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Adatok');
            
            const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });

            await uploadFile(currentPartner.databaseFileId, blob);
            partnerDatabase = [...updatedDataForSheet];

            notificationEl.className = 'text-center my-4 text-green-400 font-semibold h-auto';
            notificationEl.textContent = `Az 'adatbazis.xlsx' sikeresen frissítve a Drive-on!`;
            setTimeout(() => {
                newDeviceData = []; lastDeviceData = {};
                showScreen('ejkMain');
            }, 4000);
        } catch (err) {
            const errorDetails = err.message || err.toString();
            notificationEl.className = 'text-center my-4 text-red-400 font-semibold h-auto';
            notificationEl.textContent = `Hiba a Drive-ra mentés során: ${errorDetails}`;
        }
    }

    async function uploadFile(fileId, blob) {
        const accessToken = gapi.client.getToken().access_token;
        const response = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
            method: 'PATCH',
            headers: {
                'Authorization': `Bearer ${accessToken}`,
                'Content-Type': blob.type
            },
            body: blob
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error.message || `HTTP error! status: ${response.status}`);
        }
        return await response.json();
    }

    async function handleProcessFilesEjk() {
        const statusEl = document.getElementById('generationStatusEjk');
        const selectedCheckboxes = document.querySelectorAll('#deviceListEjk input[type="checkbox"]:checked');
        const templateFileId = document.getElementById('templateSelectEjk').value;
        const expertName = document.getElementById('expertSelectEjk').value;
        const expertId = expertIds[expertName];
    
        if (selectedCheckboxes.length === 0) {
            alert('Kérlek, válassz ki legalább egy eszközt a listából!');
            return;
        }
        if (!templateFileId) {
            alert('Kérlek, válassz egy jegyzőkönyv sablont!');
            return;
        }
        if (!expertName || !expertId) {
            alert('Kérlek, válassz egy szakértőt!');
            return;
        }
    
        statusEl.innerHTML = `<div class="loader mx-auto"></div><p>Sablonfájl letöltése...</p>`;
        let tempFolderId = null;
    
        try {
            // === 1. FÁZIS: Ideiglenes mappa létrehozása és PDF-ek generálása a Drive-on ===
            const now = new Date();
            const timestamp = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}-${String(now.getMinutes()).padStart(2, '0')}`;
            const tempFolderName = `Jegyzokonyvek_temp_${timestamp}`;
    
            statusEl.innerHTML = `<div class="loader mx-auto"></div><p>Ideiglenes mappa létrehozása...</p>`;
            const folderMetadata = {
                'name': tempFolderName,
                'mimeType': 'application/vnd.google-apps.folder',
                'parents': [currentPartner.folderId]
            };
            const folderResponse = await gapi.client.drive.files.create({ resource: folderMetadata, fields: 'id' });
            tempFolderId = folderResponse.result.id;
    
            const templateResponse = await gapi.client.drive.files.get({ fileId: templateFileId, alt: 'media' });
            const templateContent = templateResponse.body;
    
            const generatedPdfIds = [];
    
            for (let i = 0; i < selectedCheckboxes.length; i++) {
                const checkbox = selectedCheckboxes[i];
                const deviceIndex = parseInt(checkbox.dataset.deviceIndex, 10);
                const deviceData = partnerDatabase[deviceIndex];
                const deviceName = findValue(deviceData, 'Megnevezés');
    
                statusEl.innerHTML = `<div class="loader mx-auto"></div><p>DOCX generálása: ${i + 1}/${selectedCheckboxes.length} (${deviceName})</p>`;
                const docxData = await generateDocxData(deviceData, { name: expertName, id: expertId });
                
                // Új adatok hozzáadása a `partnerDatabase` megfelelő sorához
                const originalDeviceData = partnerDatabase[deviceIndex];
                originalDeviceData['Sorszám'] = docxData.sorszam;
                originalDeviceData['Kelt'] = docxData.kelt;
                originalDeviceData['Időbélyeg'] = docxData.idobelyeg;
                originalDeviceData['Vizsgáló'] = docxData.szakerto_neve;

                const zip = new PizZip(templateContent);
                const doc = new docxtemplater(zip, { paragraphLoop: true, linebreaks: true });
                doc.setData(docxData);
                try {
                    doc.render();
                } catch (error) {
                    console.error("Docxtemplater hiba:", JSON.stringify({error: error, data: docxData}));
                    throw error;
                }
                const generatedDoc = doc.getZip().generate({
                    type: "blob",
                    mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                });
    
                statusEl.innerHTML = `<div class="loader mx-auto"></div><p>PDF konvertálása és mentése: ${i + 1}/${selectedCheckboxes.length}</p>`;
                const pdfBlob = await convertDocxToPdf(generatedDoc);
    
                const pdfFileName = `${findValue(deviceData, 'Típus')}_${findValue(deviceData, 'Gyári szám')}_jkv.pdf`.replace(/[^a-zA-Z0-9_.-]/g, '_');
                const pdfMetadata = { 'name': pdfFileName, 'parents': [tempFolderId] };
                const pdfForm = new FormData();
                pdfForm.append('metadata', new Blob([JSON.stringify(pdfMetadata)], { type: 'application/json' }));
                pdfForm.append('file', pdfBlob);
    
                const pdfUploadRes = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${gapi.client.getToken().access_token}` },
                    body: pdfForm
                });
                const uploadedPdf = await pdfUploadRes.json();
                if (!uploadedPdf.id) throw new Error(`PDF feltöltése sikertelen: ${pdfFileName}`);
                generatedPdfIds.push({ id: uploadedPdf.id, name: pdfFileName });
            }
    
            // === 2. FÁZIS: PDF-ek letöltése a böngészőbe és ZIP készítése ===
            statusEl.innerHTML = `<div class="loader mx-auto"></div><p>ZIP archívum készítése...</p>`;
            const zip = new JSZip();
    
            for (let i = 0; i < generatedPdfIds.length; i++) {
                const fileInfo = generatedPdfIds[i];
                statusEl.innerHTML = `<div class="loader mx-auto"></div><p>Fájl hozzáadása a ZIP-hez: ${i + 1}/${generatedPdfIds.length} (${fileInfo.name})</p>`;
                const fileResponse = await gapi.client.drive.files.get({ fileId: fileInfo.id, alt: 'media' });
                zip.file(fileInfo.name, fileResponse.body, { binary: true });
            }
    
            statusEl.innerHTML = `<div class="loader mx-auto"></div><p>Véglegesítés... A letöltés hamarosan indul.</p>`;
            const zipBlob = await zip.generateAsync({ type: "blob" });
            saveAs(zipBlob, `Jegyzokonyvek_${currentPartner.name}_${timestamp}.zip`);
    
            statusEl.className = 'text-center my-4 text-green-400 font-semibold h-auto';
            statusEl.textContent = `Sikeres generálás! A(z) ${selectedCheckboxes.length} jegyzőkönyvet tartalmazó ZIP fájl letöltése elindult.`;

            // Az adatbázis frissítése a Drive-on az új metaadatokkal
            statusEl.innerHTML += '<p class="text-sm text-slate-400 mt-2">Adatbázis frissítése a metaadatokkal...</p>';
            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.json_to_sheet(partnerDatabase);
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Adatok');
            const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            await uploadFile(currentPartner.databaseFileId, blob);
    
        } catch (err) {
            const errorDetails = err.result?.error?.message || err.message || err.toString();
            statusEl.className = 'text-center my-4 text-red-400 font-semibold h-auto';
            statusEl.textContent = `Hiba a feldolgozás során: ${errorDetails}`;
        } finally {
            // === 3. FÁZIS: Ideiglenes mappa törlése ===
            if (tempFolderId) {
                statusEl.innerHTML += '<p class="text-sm text-slate-400 mt-2">Ideiglenes fájlok törlése a Drive-ról...</p>';
                try {
                    await gapi.client.drive.files.delete({ fileId: tempFolderId });
                    statusEl.innerHTML = statusEl.innerHTML.replace('<p class="text-sm text-slate-400 mt-2">Ideiglenes fájlok törlése a Drive-ról...</p>', '<p class="text-sm text-slate-500 mt-2">Takarítás befejezve.</p>');
                } catch (cleanupErr) {
                    console.error("Hiba az ideiglenes mappa törlésekor:", cleanupErr);
                    statusEl.innerHTML += '<p class="text-sm text-red-500 mt-1">Az ideiglenes mappa törlése sikertelen. Kérlek, manuálisan töröld a Drive-ról!</p>';
                }
            }
        }
    }

    async function convertDocxToPdf(docxBlob) {
        let tempDocId = null;
        try {
            const tempFileName = `temp_conversion_${Date.now()}.docx`;
            const fileMetadata = {
                'name': tempFileName,
                'parents': [currentPartner.folderId],
                'mimeType': 'application/vnd.google-apps.document' // Konvertálás Google Docs-ra
            };
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(fileMetadata)], { type: 'application/json' }));
            form.append('file', docxBlob);
    
            const uploadRes = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${gapi.client.getToken().access_token}` },
                body: form
            });
            const uploadedFile = await uploadRes.json();
            if (!uploadedFile.id) throw new Error('Fájl konvertálása Google Docs formátumra sikertelen.');
            tempDocId = uploadedFile.id;
    
            const exportUrl = `https://www.googleapis.com/drive/v3/files/${tempDocId}/export?mimeType=application/pdf`;
            const pdfRes = await fetch(exportUrl, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${gapi.client.getToken().access_token}` }
            });
            if (!pdfRes.ok) throw new Error('PDF exportálás sikertelen.');
            return await pdfRes.blob();
        } finally {
            if (tempDocId) {
                await gapi.client.drive.files.delete({ fileId: tempDocId });
            }
        }
    }

    async function generateDocxData(data, expert) {
        const keyMap = {
            'Cégnév': 'uzemelteto_cegnev',
            'Cím':  'uzemelteto_cim',
            'Megnevezés': 'eszkoz_megnevezes',
            'Üzemeltetői azonosító': 'eszkoz_uzemeltetoi_azonosito',
            'Típus': 'eszkoz_tipus',
            'Hasznos hossz': 'eszkoz_hossz',
            'Teherbírás (WLL)': 'eszkoz_teherbiras',
            'Gyártó': 'eszkoz_gyarto',
            'Gyári szám': 'eszkoz_gyariszam',
            'Gyártás éve': 'gyartas_eve',
            'Vizsgálat helye': 'vizsgalat_helye',
            'Vizsgálat időpontja': 'vizsgalat_idopontja',
            'Vizsgálat jellege': 'vizsgalat_jellege',
            'Megállapítások': 'megallapitasok',
            'Feltárt hiba': 'hiba',
            'Felhasznált anyagok': 'intezkedes',
            'Következő időszakos vizsgálat': 'kovetkezo_idoszakos_vizsgalat',
            'Következő terhelési próba': 'kovetkezo_terhelesi_proba',
        };

        const templateData = {};
        // 1. Adatok átmásolása az Excelből a keyMap alapján
        for (const key in data) {
            const templateKey = keyMap[key];
            if (templateKey) {
                templateData[templateKey] = findValue(data, key);
            }
        }

        // 2. Automatikusan generált adatok hozzáadása
        const now = new Date();
        templateData.kelt = now.toISOString().slice(0, 10);

        // Időbélyeg generálása SHA-256 hash alapján
        const inspectionDate = findValue(data, 'Vizsgálat időpontja');
        const serialNumberForHash = findValue(data, 'Gyári szám');
        const sourceString = `${inspectionDate}-${serialNumberForHash}`;
        
        const encoder = new TextEncoder();
        const dataBuffer = encoder.encode(sourceString);
        const hashBuffer = await crypto.subtle.digest('SHA-256', dataBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        templateData.idobelyeg = hashHex.substring(0, 12);
        
        // Sorszám generálása a megadott formátum szerint
        const partnerPrefix = currentPartner.name.substring(0, 4).toUpperCase();
        const deviceSerial = findValue(data, 'Gyári szám');
        const currentYear = now.getFullYear();
        templateData.sorszam = `${partnerPrefix}/${deviceSerial}/${currentYear}`;

        // 3. Szakértői adatok hozzáadása
        templateData.szakerto_neve = expert.name || '';
        templateData.szakerto_azonosito = expert.id || '';

        return templateData;
    }
    
    let sortState = { key: 'Megnevezés', direction: 'asc' };

    function handleSortDeviceList(key) {
        if (sortState.key === key) {
            sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
        } else {
            sortState.key = key;
            sortState.direction = 'asc';
        }
        renderDeviceList();
    }

    function renderDeviceList() {
        const sortedDatabase = [...partnerDatabase].sort((a, b) => {
            const valA = findValue(a, sortState.key);
            const valB = findValue(b, sortState.key);
            const direction = sortState.direction === 'asc' ? 1 : -1;
            return valA.localeCompare(valB, 'hu', { numeric: true }) * direction;
        });

        const deviceListHtml = sortedDatabase.map((device, index) => {
            const originalIndex = partnerDatabase.indexOf(device); // Eredeti index a checkboxhoz
            const deviceName = findValue(device, 'Megnevezés');
            const deviceType = findValue(device, 'Típus');
            const deviceLength = findValue(device, 'Hasznos hossz');
            const deviceSerial = findValue(device, 'Gyári szám');
            const deviceId = findValue(device, 'Üzemeltetői azonosító');
            return `
                <label for="device_${originalIndex}" class="flex items-center p-2 bg-blue-900/50 rounded-md hover:bg-blue-800/70 transition-colors cursor-pointer">
                    <input type="checkbox" id="device_${originalIndex}" data-device-index="${originalIndex}" class="form-checkbox h-5 w-5 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                    <span class="ml-3 text-sm font-semibold w-1/4 truncate px-2" title="${deviceName}">${deviceName}</span>
                    <span class="text-sm text-gray-400 w-1/4 truncate px-2" title="${deviceType}">${deviceType || 'N/A'}</span>
                    <span class="text-sm text-gray-400 w-1/6 truncate px-2" title="${deviceLength}">${deviceLength || 'N/A'}</span>
                    <span class="text-sm text-gray-400 w-1/4 truncate px-2" title="${deviceId}">${deviceId || 'N/A'}</span>
                    <span class="text-sm text-gray-400 w-1/4 truncate px-2" title="${deviceSerial}">${deviceSerial || 'N/A'}</span>
                </label>
            `;
        }).join('');

        document.getElementById('deviceListEjk').innerHTML = deviceListHtml || '<p class="p-4 text-center text-gray-400">Nincs eszköz az adatbázisban.</p>';
        updateSortIndicators();
    }

    function updateSortIndicators() {
        document.querySelectorAll('[data-sort-key]').forEach(el => {
            el.classList.remove('text-white');
            el.innerHTML = el.innerHTML.replace(/ (↑|↓)$/, ''); // Remove old arrow
            if (el.dataset.sortKey === sortState.key) {
                el.classList.add('text-white');
                el.innerHTML += sortState.direction === 'asc' ? ' ↑' : ' ↓';
            }
        });
    }

    // --- HTML GENERÁLÓ FÜGGVÉNYEK ---
    function getEjkDataEntryHtml() {
        return `
            <header class="bg-blue-950/70 p-4 rounded-t-xl mb-1 shadow-lg border-b border-blue-800">
                <h2 class="text-xl font-bold text-center">Adatbevitel - ${currentPartner.name}</h2>
            </header>
            <div class="card rounded-t-none">
                 <form id="dataEntryFormEjk" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="space-y-4 p-4 bg-blue-900/50 rounded-lg">
                        <h3 class="text-lg font-semibold border-b border-blue-700 pb-2 mb-4">A vizsgált eszköz adatai</h3>
                        <div><label class="block text-sm">Megnevezés:</label><input name="eszkoz_megnevezes" class="input-field" required></div>
                        <div><label class="block text-sm">Üzemeltetői azonosító:</label><input name="eszkoz_uzemeltetoi_azonosito" class="input-field"></div>
                        <div><label class="block text-sm">Típus:</label><input name="eszkoz_tipus" class="input-field"></div>
                        <div><label class="block text-sm">Hasznos hossz:</label><input name="eszkoz_hossz" class="input-field"></div>
                        <div><label class="block text-sm">Teherbírás (WLL):</label><input name="eszkoz_teherbiras" class="input-field"></div>
                        <div><label class="block text-sm">Gyártó:</label><input name="eszkoz_gyarto" class="input-field"></div>
                        <div><label class="block text-sm">Gyári szám:</label><input name="eszkoz_gyariszam" class="input-field" required></div>
                        <div><label class="block text-sm">Gyártás éve:</label><input name="gyartas_eve" class="input-field"></div>
                    </div>
                     <div class="space-y-4 p-4 bg-blue-900/50 rounded-lg">
                        <h3 class="text-lg font-semibold border-b border-blue-700 pb-2 mb-4">A vizsgálat adatai</h3>
                        <div><label class="block text-sm">Vizsgálat helye:</label><input name="vizsgalat_helye" class="input-field"></div>
                        <div><label class="block text-sm">Vizsgálat időpontja:</label><input name="vizsgalat_idopontja" type="date" class="input-field"></div>
                        <div><label class="block text-sm">Vizsgálat jellege:</label><input name="vizsgalat_jellege" class="input-field"></div>
                        <div><label class="block text-sm">Következő időszakos vizsgálat:</label><input name="kovetkezo_idoszakos_vizsgalat" type="date" class="input-field"></div>
                        <div><label class="block text-sm">Következő terhelési próba:</label><input name="kovetkezo_terhelesi_proba" type="date" class="input-field"></div>
                    </div>
                     <div class="space-y-4 p-4 bg-blue-900/50 rounded-lg">
                        <h3 class="text-lg font-semibold border-b border-blue-700 pb-2 mb-4">Eredmény és minősítés</h3>
                        <div><label class="block text-sm">Megállapítások:</label><textarea name="megallapitasok" rows="3" class="input-field"></textarea></div>
                        <div><label class="block text-sm">Feltárt hiba:</label><textarea name="hiba" rows="3" class="input-field"></textarea></div>
                        <div><label class="block text-sm">Felhasznált anyagok:</label><textarea name="intezkedes" rows="3" class="input-field"></textarea></div>
                    </div>
                </form>
                <div id="notificationEjk" class="text-center my-4 text-green-400 font-semibold h-6"></div>
                <div class="flex flex-col sm:flex-row gap-4 justify-between mt-6">
                    <button id="backToEjkMainBtn" class="btn btn-secondary">Vissza a főmenübe</button>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button id="addAnotherDeviceBtnEjk" class="btn btn-primary">Adatok hozzáadása és új eszköz</button>
                        <button id="saveToDriveBtnEjk" class="btn btn-success">Változtatások mentése a Drive-ra</button>
                    </div>
                </div>
            </div>`;
    }
    function getEjkDocGenerationHtml() {
        // Dinamikusan betöltjük a sablonokat, miután a HTML a DOM-ba került
        setTimeout(async () => {
            renderDeviceList(); // Lista kirajzolása a rendezés alapján

            const selectEl = document.getElementById('templateSelectEjk');
            const statusEl = document.getElementById('templateStatusEjk');
            const generateBtn = document.getElementById('processFilesBtnEjk');
            try {
                const response = await gapi.client.drive.files.list({
                    q: `'${currentPartner.folderId}' in parents and mimeType='application/vnd.openxmlformats-officedocument.wordprocessingml.document' and trashed=false`,
                    fields: 'files(id, name)'
                });
                if (response.result.files && response.result.files.length > 0) {
                    selectEl.innerHTML = ''; // Töröljük a "betöltés" opciót
                    response.result.files.forEach(file => {
                        const option = new Option(file.name, file.id);
                        selectEl.add(option);
                    });
                    statusEl.textContent = '';
                    selectEl.disabled = false;
                    generateBtn.disabled = false;
                } else {
                    statusEl.textContent = 'Nem található .docx sablon a partner mappájában.';
                }
            } catch (err) {
                statusEl.textContent = 'Hiba a sablonok betöltésekor.';
                console.error("Sablon betöltési hiba:", err);
            }
        }, 100);

        return `
            <div class="card max-w-4xl mx-auto">
                <h2 class="text-2xl font-bold text-center mb-6">Jegyzőkönyv Készítés - ${currentPartner.name}</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-lg font-semibold mb-3">1. Eszközök kiválasztása</h3>
                        <div class="bg-black/20 rounded p-2">
                            <div class="flex items-center p-2 border-b border-blue-700 mb-2">
                                <input type="checkbox" id="selectAllCheckboxEjk" class="form-checkbox h-5 w-5 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500 ml-3" title="Összes kijelölése/törlése">
                                <button data-sort-key="Megnevezés" class="text-xs font-bold uppercase text-blue-300 w-1/4 text-left px-2 cursor-pointer hover:text-white">Megnevezés</button>
                                <button data-sort-key="Típus" class="text-xs font-bold uppercase text-blue-300 w-1/4 text-left px-2 cursor-pointer hover:text-white">Típus</button>
                                <button data-sort-key="Hasznos hossz" class="text-xs font-bold uppercase text-blue-300 w-1/6 text-left px-2 cursor-pointer hover:text-white">Hossz</button>
                                <button data-sort-key="Üzemeltetői azonosító" class="text-xs font-bold uppercase text-blue-300 w-1/4 text-left px-2 cursor-pointer hover:text-white">Azonosító</button>
                                <button data-sort-key="Gyári szám" class="text-xs font-bold uppercase text-blue-300 w-1/4 text-left px-2 cursor-pointer hover:text-white">Gyári szám</button>
                            </div>
                            <div id="deviceListEjk" class="space-y-2 max-h-80 overflow-y-auto"><div class="loader mx-auto"></div></div>
                        </div>
                    </div>
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-lg font-semibold mb-3">2. Sablon kiválasztása</h3>
                            <select id="templateSelectEjk" class="input-field" disabled><option>Sablonok betöltése...</option></select>
                            <p id="templateStatusEjk" class="text-sm text-yellow-400 mt-2 h-4"></p>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-3">3. Szakértő kiválasztása</h3>
                            <select id="expertSelectEjk" class="input-field" required>
                                <option value="" disabled selected>Válassz egy szakértőt...</option>
                                <option value="Nagy Imre">Nagy Imre</option>
                                <option value="Gerőly Iván">Gerőly Iván</option>
                                <option value="Szadlon Norbert">Szadlon Norbert</option>
                                <option value="Bagyinszki Lóránt">Bagyinszki Lóránt</option>
                            </select>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-3">3. Generálás</h3>
                            <button id="processFilesBtnEjk" class="btn btn-success w-full" disabled>Jegyzőkönyvek generálása</button>
                            <div id="generationStatusEjk" class="text-center my-4 font-semibold h-12"></div>
                        </div>
                    </div>
                </div>
                <div class="mt-8 text-left">
                    <button id="backToEjkMainBtn" class="btn btn-secondary">Vissza a főmenübe</button>
                </div>
            </div>
        `;
    }
    
    </script>
    
</body>
</html>
